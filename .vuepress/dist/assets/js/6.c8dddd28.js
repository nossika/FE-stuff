(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{193:function(t,s,a){t.exports=a.p+"assets/img/browser.a3d3a838.png"},237:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"单线程的js"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#单线程的js","aria-hidden":"true"}},[t._v("#")]),t._v(" 单线程的JS")]),t._v(" "),n("h2",{attrs:{id:"几个基本概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#几个基本概念","aria-hidden":"true"}},[t._v("#")]),t._v(" 几个基本概念")]),t._v(" "),n("h3",{attrs:{id:"进程和线程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#进程和线程","aria-hidden":"true"}},[t._v("#")]),t._v(" 进程和线程")]),t._v(" "),n("p",[t._v("进程是系统分配资源的最小单位，线程是系统运算和调度的最小单位。一个进程内可有单或多个线程，进程和线程都由操作系统管理。")]),t._v(" "),n("h3",{attrs:{id:"协程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#协程","aria-hidden":"true"}},[t._v("#")]),t._v(" 协程")]),t._v(" "),n("p",[t._v("协程是更轻量的运算单位，由"),n("strong",[t._v("程序")]),t._v("基于线程去创建和调度（一般在语言层实现，比如go、python等），操作系统对协程的存在无感知。可能是一个线程对应多个协程，也可能是多个线程对应多个协程，协程间的切换可以不依赖线程切换，取决于程序的设计。")]),t._v(" "),n("h3",{attrs:{id:"并发、并行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发、并行","aria-hidden":"true"}},[t._v("#")]),t._v(" 并发、并行")]),t._v(" "),n("p",[t._v("并发是"),n("strong",[t._v("一定时间段内")]),t._v("完成多条指令。比如有3个耗时0.5s的运算，程序通过资源调度在0.6s内完成了这3个原本总和需要1.5s的运算，称为并发。浏览器中，JS的事件循环通过对多线程的调度即可实现并发。")]),t._v(" "),n("p",[t._v("并行是"),n("strong",[t._v("同一时间点")]),t._v("有多条指令在同时执行，所以其前提必须是多核CPU。NodeJS中可以通过cluster模块来利用多核CPU实现并行。")]),t._v(" "),n("h2",{attrs:{id:"多进程的浏览器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#多进程的浏览器","aria-hidden":"true"}},[t._v("#")]),t._v(" 多进程的浏览器")]),t._v(" "),n("p",[t._v("浏览器一般是多进程的应用。以chrome为例")]),t._v(" "),n("p",[t._v("包含进程有（shift+esc可查看）：")]),t._v(" "),n("ul",[n("li",[t._v("浏览器主进程")]),t._v(" "),n("li",[t._v("GPU进程：GPU加速")]),t._v(" "),n("li",[t._v("tab页进程：每个tab页对应一个进程")]),t._v(" "),n("li",[t._v("扩展程序（第三方插件）进程")])]),t._v(" "),n("p",[t._v("页面进程中又包含多个线程：")]),t._v(" "),n("ul",[n("li",[t._v("JS引擎线程")]),t._v(" "),n("li",[t._v("GUI渲染线程：DOM渲染")]),t._v(" "),n("li",[t._v("事件控制线程：实现event loop")]),t._v(" "),n("li",[t._v("定时触发器线程：setTimeout、setInterval等计时器")]),t._v(" "),n("li",[t._v("网络请求线程：如http请求")]),t._v(" "),n("li",[t._v("webWorker线程（sharedWorker线程归属浏览器主进程）")])]),t._v(" "),n("p",[t._v("JS线程与GUI线程互斥（一个执行时另一个会被挂起），因为JS可以读取DOM的渲染数据，须保证读取到的数据准确。浏览器一般在JS线程空闲时执行layout&paint，如果在JS线程执行中触发layout，JS线程会阻塞，等其执行完毕再继续。")]),t._v(" "),n("blockquote",[n("p",[t._v("渲染相关详见"),n("router-link",{attrs:{to:"/htmlcss/render.html"}},[t._v("【页面渲染】")]),t._v("。")],1)]),t._v(" "),n("h2",{attrs:{id:"事件循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件循环","aria-hidden":"true"}},[t._v("#")]),t._v(" 事件循环")]),t._v(" "),n("h3",{attrs:{id:"浏览器的事件循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器的事件循环","aria-hidden":"true"}},[t._v("#")]),t._v(" 浏览器的事件循环")]),t._v(" "),n("p",[t._v("JS本身是单线程，但执行JS的环境不是。宿主一般会有JS主线程、调度线程、网络请求线程等多个线程配合来运行程序，所以单线程的JS能实现非阻塞。")]),t._v(" "),n("p",[t._v("浏览器中以事件循环模型来运行JS，如下图：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(193),alt:"event loop"}})]),t._v(" "),n("p",[t._v("事件循环模型包含执行栈（JS stack）和事件队列（event queue），由调度线程来控制整体的调度。执行栈即JS主线程，在主线程运行中，一旦遇到异步操作（比如setTimeout/http请求等）时，会交给另外的线程处理（比如setTimeout交给定时器线程、http请求交给网络请求线程），当其他线程返回结果后，调度线程会将事件推入事件队列中，按先进先出原则待主线程处理。")]),t._v(" "),n("p",[t._v("每一轮循环称为一个task，每轮循环的末尾还会检查并执行微任务（micro task queue）队列。")]),t._v(" "),n("p",[t._v("主线程空闲时（即一轮事件循坏结束），会从事件队列取出事件（如果有的话）加入执行栈执行（即进入下轮事件循环）。如果执行栈再遇到异步操作，则重复上述调度行为。")]),t._v(" "),n("blockquote",[n("p",[t._v("NodeJS中的事件循环略有不同，详见"),n("router-link",{attrs:{to:"/node/loop.html"}},[t._v("【事件循环（NodeJS）】")])],1)]),t._v(" "),n("h3",{attrs:{id:"task-microtask"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#task-microtask","aria-hidden":"true"}},[t._v("#")]),t._v(" task/microTask")]),t._v(" "),n("p",[t._v("事件循环中有task和microTask的概念")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("repeat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tPromise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resovle")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("repeat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("repeat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 'setTimeout'永远不会被打印，因为无限执行microTask，不会进入下个loop")]),t._v("\n")])])]),n("p",[t._v("如果改成")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("repeat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("repeat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("repeat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 'setTimeout'会被打印")]),t._v("\n")])])]),n("p",[t._v("执行顺序")]),t._v(" "),n("p",[t._v("loop ( 一轮循环开始 -> task -> microTask -> 一轮循环结束 ) => nextLoop ( 一轮循环开始 -> task -> microTask -> 一轮循环结束 ) => nextLoop => ...")]),t._v(" "),n("p",[t._v("task类型: setTimeout, MessageChannel")]),t._v(" "),n("p",[t._v("microTask类型: Promise, MutationObserver")]),t._v(" "),n("h4",{attrs:{id:"settimeout-setinterval"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#settimeout-setinterval","aria-hidden":"true"}},[t._v("#")]),t._v(" setTimeout/setInterval")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loop1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do sth.")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loop1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loop1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loop2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do sth.")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("loop2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("两者都表示1s执行一次的循环，区别在于这个间隔1s，它在loop1中是本次"),n("code",[t._v("do sth.")]),t._v("执行完才触发下次计时，而loop2是一直在计时（因为计时器是单独的线程，不被主线程阻塞），一次计时完毕后立刻开始下一次。当"),n("code",[t._v("do sth.")]),t._v("耗时越高它们的行为差别越明显，setInterval可能连续多次触发"),n("code",[t._v("do sth.")]),t._v("。")]),t._v(" "),n("h3",{attrs:{id:"webworker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#webworker","aria-hidden":"true"}},[t._v("#")]),t._v(" WebWorker")]),t._v(" "),n("h4",{attrs:{id:"worker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#worker","aria-hidden":"true"}},[t._v("#")]),t._v(" Worker")]),t._v(" "),n("p",[t._v("用法：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// main.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" worker "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Worker")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./worker.js'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("postMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'main msg'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("onmessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tmsg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 'worker msg'")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// workder.terminate();  ")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// worker.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onmessage")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tmsg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  'main msg'")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("postMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'worker msg'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("Worker会独立开启一个线程执行，不占用主线程资源，post出来的数据推入事件队列待主线程处理。")]),t._v(" "),n("h4",{attrs:{id:"sharedworker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sharedworker","aria-hidden":"true"}},[t._v("#")]),t._v(" SharedWorker")]),t._v(" "),n("p",[t._v("用法同Worker，区别在于SharedWorker是独立进程，多tab页可共享一个")])])},[],!1,null,null,null);s.default=e.exports}}]);